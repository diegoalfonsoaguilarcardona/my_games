<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Taller de Robots - Restas con Reagrupaci√≥n (C-D-U)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --panel:#171a25;
      --ok:#32d296;
      --bad:#ff496c;
      --text:#e8ecf1;
      --muted:#aeb7c2;
      --c:#7b9acc; --d:#6fcf97; --u:#f2994a;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial;
      color:var(--text); background:linear-gradient(180deg,#0b0d12, #151926);
      min-height:100vh; display:flex; flex-direction:column;
    }
    header{
      padding:16px 20px; background:#0f1320; border-bottom:1px solid #223;
      display:flex; align-items:center; gap:12px; flex-wrap:wrap;
    }
    header h1{margin:0; font-size:20px}
    .chip{ background:#1c2133; color:#6cf0ff; padding:3px 8px; border-radius:999px; font-size:12px; border:1px solid #22354a; }
    .container{
      padding:16px; display:grid; grid-template-columns:1.2fr .8fr; gap:16px; max-width:1200px; width:100%; margin:0 auto;
    }
    .card{
      background:var(--panel); border:1px solid #22283a; border-radius:12px; padding:14px;
      box-shadow:0 10px 30px rgba(0,0,0,.25), inset 0 1px 0 rgba(255,255,255,.03);
    }
    .controls{ display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin-bottom:10px; }
    .controls select,.controls button,.controls input[type="number"]{
      background:#1b2133; color:var(--text); border:1px solid #2a334d; border-radius:8px; padding:10px 12px; font-size:14px; outline:none;
    }
    .controls button{ background:linear-gradient(180deg,#1e2740,#192238); cursor:pointer; }
    .controls .stat{color:var(--muted); font-size:13px; padding:6px 10px; background:#111623; border-radius:8px; border:1px solid #20263a}
    .grid{ display:grid; grid-template-columns:repeat(3,1fr); gap:6px; align-items:end; user-select:none; }
    .col-label{ font-size:12px; color:var(--muted); text-align:center; margin-bottom:6px; }
    .col-header{display:grid; grid-template-columns:repeat(3,1fr); gap:6px}
    .place.C{color:var(--c)} .place.D{color:var(--d)} .place.U{color:var(--u)}

    .num-box{
      background:#111626; border:1px solid #20263a; border-radius:10px; padding:8px 4px; text-align:center; position:relative;
      min-height:64px; display:flex; align-items:center; justify-content:center;
    }
    .digit{
      font-size:36px; font-weight:800; line-height:1; color:#e9f3ff; position:relative; z-index:1;
      transition:color .15s ease, opacity .15s ease;
    }
    .digit.crossed{
      color:#ffb3b3;
      text-decoration: line-through;
      text-decoration-thickness: 3px;
      text-decoration-color: #ff7a7a;
    }
    .scribble-new{
      position:absolute; top:-6px; right:8px; font-size:16px; color:#cfe8ff; background:#0c1426; padding:2px 6px; border-radius:8px;
      border:1px solid #2a3550; box-shadow:0 1px 0 rgba(255,255,255,.06) inset; z-index:3;
      min-width: 28px; min-height: 22px; display:flex; align-items:center; justify-content:center;
    }
    .scribble-new .s-input{
      width: 38px; max-width: 46px; text-align:center; font-weight:700; font-size:14px; color:#cfe8ff;
      background:#0c1426; border:1px solid #2a3550; border-radius:6px; padding:2px 4px; outline:none;
    }
    .scribble-new .s-input.ok{ border-color:#2da87a; color:#bfffe9; background:#0f1e1a; }
    .scribble-new .s-input.bad{ border-color:#ff6f86; color:#ffd2d9; background:#1f0f16; }

    .op-row{ display:grid; grid-template-columns:repeat(3,1fr); gap:6px; align-items:center; margin-top:6px; }
    .minus{ position:absolute; left:8px; top:4px; color:#9db; font-weight:700; font-size:14px; }
    .sep{ height:2px; background:linear-gradient(90deg,#24314b, #2e395b); border-radius:2px; margin:10px 4px;}
    .ans-row{ display:grid; grid-template-columns:repeat(3,1fr); gap:6px; align-items:center; }
    .ans{
      width:100%; text-align:center; font-size:34px; font-weight:800; color:#e9f3ff;
      background:#0f1422; border:1px solid #26314f; border-radius:10px; padding:8px 0;
    }
    .ans:disabled{opacity:.4}
    .active-col{ outline:2px solid #3f72ff55; box-shadow:0 0 0 4px #3f72ff18 inset; }
    .hint{ margin-top:10px; font-size:14px; color:#cfe1ff; background:#111827; border:1px dashed #2a3550; padding:10px; border-radius:10px; }
    .borrow-row{ display:grid; grid-template-columns:repeat(3,1fr); gap:6px; margin-top:8px; }
    .borrow-btn{ background:#1b2439; color:#e7f1ff; border:1px solid #2a385a; border-radius:10px; padding:8px; font-size:13px; cursor:pointer; }
    .borrow-btn[disabled]{opacity:.35; cursor:not-allowed}
    .module{ background:#101625; border:1px solid #203050; border-radius:10px; padding:10px; }
    .module h4{margin:0 0 6px 0; font-size:13px; color:#9fb3d6}
    .stack{
      display:flex; flex-wrap:wrap; gap:6px; min-height:42px; padding:6px; background:#0b1120; border-radius:8px; border:1px solid #1a2338;
    }
    .block{ width:18px; height:18px; border-radius:4px; border:1px solid rgba(255,255,255,.15); box-shadow:inset 0 1px 0 rgba(255,255,255,.06); }
    .block.C{width:30px; height:30px; background:linear-gradient(180deg,#6f86c8,#4b5f93)}
    .block.D{width:24px; height:24px; background:linear-gradient(180deg,#64d79b,#3aa773)}
    .block.U{width:18px; height:18px; background:linear-gradient(180deg,#ffb36b,#d67b2a)}
    .feedback{ margin-top:8px; min-height:22px; font-size:14px; }
    .feedback.ok{color:var(--ok)} .feedback.bad{color:var(--bad)}
    .footer{ text-align:center; padding:12px; color:#8fa1ba; font-size:12px; }
    .shake{animation:shake .25s ease}
    @keyframes shake{0%{transform:translateX(0)}25%{transform:translateX(-4px)}50%{transform:translateX(4px)}75%{transform:translateX(-2px)}100%{transform:translateX(0)}}
    .row{ display:flex; align-items:center; gap:8px; justify-content:space-between; }
    .tiny{font-size:11px; color:#a5b4d6}
    .timer{
      display:flex; align-items:center; gap:10px; min-width:260px;
      background:#0f1422; border:1px solid #26314f; border-radius:10px; padding:8px 10px;
    }
    .timer .time-text{min-width:52px; text-align:right; font-weight:700}
    .timer .bar{ position:relative; flex:1; height:12px; background:#0c1224; border:1px solid #1f2a45; border-radius:999px; overflow:hidden; }
    .timer .bar .fill{ position:absolute; left:0; top:0; bottom:0; width:100%; background:linear-gradient(90deg, #37d2ff, #1d7cff); transition:width .15s linear, background .2s ease; }
    .timer.low .bar .fill{ background:linear-gradient(90deg, #ffb037, #ff5e5e); animation:pulse 0.9s ease-in-out infinite; }
    @keyframes pulse{ 0%{filter:brightness(1)} 50%{filter:brightness(1.4)} 100%{filter:brightness(1)} }
    .sound-toggle{ background:#16203a; border:1px solid #2a3550; color:#cfe1ff; border-radius:999px; padding:6px 10px; font-size:13px; cursor:pointer; }
    .sound-toggle.off{opacity:.6}
    .mode-tag{font-size:12px; padding:4px 8px; border-radius:999px; border:1px solid #2a3550; background:#121a2e; color:#bcd0ff}
    .lives{ display:flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; background:#12192a; border:1px solid #22304e; }
    .heart{filter: drop-shadow(0 0 2px rgba(255,0,0,.4)); font-size:16px}
    .heart.lost{opacity:.25; filter:none}
    .heart.flash{animation:hl 0.5s ease}
    @keyframes hl{0%{transform:scale(1)} 50%{transform:scale(1.3)} 100%{transform:scale(1)}}
    .overlay{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; backdrop-filter: blur(2px); }
    .overlay .panel{
      background:#0f1422; border:1px solid #2a3550; border-radius:14px; padding:20px; width:min(520px, 92vw);
      text-align:center; box-shadow:0 20px 60px rgba(0,0,0,.5);
    }
    .big{font-size:20px; font-weight:700}
    .btn{ background:#1e2740; color:#cfe8ff; border:1px solid #2a3550; padding:10px 14px; border-radius:10px; cursor:pointer; }
    .checkbox{
      display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:8px; border:1px solid #2a334d; background:#141b2e;
      color:#d6e2ff; font-size:12px;
    }
  </style>
</head>
<body>
  <header>
    <span class="chip">Aprendizaje Activo</span>
    <h1>Taller de Robots ¬∑ Restas con reagrupaci√≥n (Centenas- Decenas- Unidades)</h1>
  </header>

  <div class="container">
    <section class="card">
      <div class="controls">
        <label class="tiny">Modo:
          <select id="mode">
            <option value="progresivo">Progresivo</option>
            <option value="sin">Sin pr√©stamo</option>
            <option value="unidad">Pr√©stamo en unidades</option>
            <option value="du">Pr√©stamo en decenas/unidades (y escalera)</option>
            <option value="aleatorio" selected>Aleatorio</option>
          </select>
        </label>

        <label class="checkbox" title="Si se activa, el jugador debe escribir los nuevos valores (arriba) tras pedir prestado.">
          <input id="requireScribble" type="checkbox" checked />
          Solicitar nuevos valores tras pr√©stamo
        </label>

        <label class="tiny" title="Tiempo inicial del primer ejercicio">
          Inicio (s): <input id="initTime" type="number" min="10" max="180" value="120" style="width:80px" />
        </label>
        <label class="tiny" title="Segundos menos por cada nuevo ejercicio">
          ‚àí por juego (s): <input id="decayTime" type="number" min="0" max="10" value="2" style="width:80px" />
        </label>

        <div class="timer" id="timer">
          <div class="time-text" id="timeText">00:00</div>
          <div class="bar"><div class="fill" id="timeFill" style="width:100%"></div></div>
          <button id="soundBtn" class="sound-toggle off" title="Sonido">üîà</button>
        </div>

        <div class="lives" id="lives">
          <span class="tiny">Vidas:</span>
          <span class="heart" data-i="0">‚ù§Ô∏è</span>
          <span class="heart" data-i="1">‚ù§Ô∏è</span>
          <span class="heart" data-i="2">‚ù§Ô∏è</span>
          <span class="heart" data-i="3">‚ù§Ô∏è</span>
          <span class="heart" data-i="4">‚ù§Ô∏è</span>
          <span class="heart" data-i="5">‚ù§Ô∏è</span>
        </div>

        <button id="revealBtn">Mostrar soluci√≥n</button>

        <span class="stat" id="stat">Aciertos: 0 ¬∑ Errores: 0</span>
        <span class="mode-tag tiny" id="stageTag">Modo: Aleatorio</span>
      </div>

      <div class="col-header">
        <div class="col-label place C">Centenas (C)</div>
        <div class="col-label place D">Decenas (D)</div>
        <div class="col-label place U">Unidades (U)</div>
      </div>

      <div class="grid" id="topRow">
        <div class="num-box" id="A_C">
          <span class="digit" id="valA_C">0</span>
          <span class="scribble-new" id="newC"></span>
        </div>
        <div class="num-box" id="A_D">
          <span class="digit" id="valA_D">0</span>
          <span class="scribble-new" id="newD"></span>
        </div>
        <div class="num-box" id="A_U">
          <span class="digit" id="valA_U">0</span>
          <span class="scribble-new" id="newU"></span>
        </div>
      </div>

      <div class="op-row">
        <div class="num-box" style="position:relative"><span class="minus">‚àí</span><span id="valB_C" class="digit" style="font-size:32px">0</span></div>
        <div class="num-box" style="position:relative"><span class="minus">‚àí</span><span id="valB_D" class="digit" style="font-size:32px">0</span></div>
        <div class="num-box" style="position:relative"><span class="minus">‚àí</span><span id="valB_U" class="digit" style="font-size:32px">0</span></div>
      </div>

      <div class="sep"></div>

      <div class="ans-row">
        <input id="ansC" class="ans" inputmode="numeric" maxlength="1" placeholder="C" />
        <input id="ansD" class="ans" inputmode="numeric" maxlength="1" placeholder="D" />
        <input id="ansU" class="ans" inputmode="numeric" maxlength="1" placeholder="U" />
      </div>

      <div class="borrow-row">
        <button id="borrowC" class="borrow-btn" disabled>Convertir 1 millar en 10 centenas (no usado)</button>
        <button id="borrowD" class="borrow-btn" disabled>Convertir 1 centena en 10 decenas</button>
        <button id="borrowU" class="borrow-btn" disabled>Convertir 1 decena en 10 unidades</button>
      </div>

      <div class="hint" id="hint">Pide ‚Äúprestado‚Äù: el n√∫mero original se tachar√° y el nuevo aparecer√° arriba.</div>
      <div class="feedback" id="feedback"></div>
      <div style="margin-top:10px" class="row">
        <button id="nextBtn" class="btn" style="display:none">Siguiente ejercicio</button>
        <span class="tiny" id="progress"></span>
      </div>
    </section>

    <aside class="card right-col">
      <h3>Panel del Robot: M√≥dulos de Energ√≠a</h3>
      <div class="module">
        <h4 class="place C">Centenas</h4>
        <div class="stack" id="stackC"></div>
      </div>
      <div class="module">
        <h4 class="place D">Decenas</h4>
        <div class="stack" id="stackD"></div>
      </div>
      <div class="module">
        <h4 class="place U">Unidades</h4>
        <div class="stack" id="stackU"></div>
      </div>
      <div class="tiny" style="margin-top:4px">
        Consejo: Si no alcanzan las unidades, convierte 1 decena en 10 unidades. Si no hay decenas, primero convierte 1 centena en 10 decenas.
      </div>
    </aside>
  </div>

  <div class="footer">Taller de Robots ¬∑ C-D-U ¬∑ Pr√©stamo visual con ‚Äútachado y nuevo valor arriba‚Äù ¬∑ Modo Aleatorio por defecto ¬∑ 6 vidas</div>

  <div id="overlay" class="overlay">
    <div class="panel">
      <div class="big">Game Over</div>
      <p>Se acabaron las vidas. ¬°Bien jugado! Reinicia con 6 vidas y vuelve a intentarlo.</p>
      <button id="restartBtn" class="btn">Reiniciar</button>
    </div>
  </div>

  <script>
    // Estado
    const state = {
      mode: 'aleatorio',
      A: [0,0,0], B: [0,0,0], workA: [0,0,0],
      // Valores peque√±os (arriba): null = sin tachado; '' = tachado esperando entrada; n√∫mero = mostrado
      scribbleNew: [null,null,null],
      scribbleExpect: [null,null,null],
      scribbleRequired: [false,false,false],
      scribbleCorrect: [true,true,true],
      requireNewValues: true,

      step: 2, done: [false,false,false],
      score: {ok:0, err:0, n:0},
      timedOut: false,
      lives: 6,
      progressIdx: 0,
      config: { initTime: 120, decay: 2, minTime: 10 }
    };

    // DOM
    const el = {
      mode: document.getElementById('mode'),
      requireScribble: document.getElementById('requireScribble'),

      initTime: document.getElementById('initTime'),
      decayTime: document.getElementById('decayTime'),
      revealBtn: document.getElementById('revealBtn'),
      nextBtn: document.getElementById('nextBtn'),

      A_C: document.getElementById('valA_C'),
      A_D: document.getElementById('valA_D'),
      A_U: document.getElementById('valA_U'),

      newC: document.getElementById('newC'),
      newD: document.getElementById('newD'),
      newU: document.getElementById('newU'),

      B_C: document.getElementById('valB_C'),
      B_D: document.getElementById('valB_D'),
      B_U: document.getElementById('valB_U'),

      cellA_C: document.getElementById('A_C'),
      cellA_D: document.getElementById('A_D'),
      cellA_U: document.getElementById('A_U'),

      ansC: document.getElementById('ansC'),
      ansD: document.getElementById('ansD'),
      ansU: document.getElementById('ansU'),

      bC: document.getElementById('borrowC'),
      bD: document.getElementById('borrowD'),
      bU: document.getElementById('borrowU'),

      hint: document.getElementById('hint'),
      feedback: document.getElementById('feedback'),
      stat: document.getElementById('stat'),
      progress: document.getElementById('progress'),
      stageTag: document.getElementById('stageTag'),

      stackC: document.getElementById('stackC'),
      stackD: document.getElementById('stackD'),
      stackU: document.getElementById('stackU'),

      timer: document.getElementById('timer'),
      timeText: document.getElementById('timeText'),
      timeFill: document.getElementById('timeFill'),
      soundBtn: document.getElementById('soundBtn'),

      livesWrap: document.getElementById('lives'),
      overlay: document.getElementById('overlay'),
      restartBtn: document.getElementById('restartBtn')
    };
    const scribbleEls = [el.newC, el.newD, el.newU];

    // Utilidades
    function randInt(a,b){ return Math.floor(Math.random()*(b-a+1))+a; }
    function computeDifference(A,B){
      const r = [0,0,0]; let w = [...A];
      if(w[2] < B[2]){ w[2]+=10; w[1]-=1; }
      r[2] = w[2] - B[2];
      if(w[1] < B[1]){ w[1]+=10; w[0]-=1; }
      r[1] = w[1] - B[1];
      r[0] = w[0] - B[0];
      return r;
    }

    // Generadores
    function padProblem(a,b){ return {A:a, B:b}; }
    function genNoBorrow(){
      let C = randInt(1,9), D = randInt(0,9), U = randInt(0,9);
      let c = randInt(0,C), d = randInt(0,D), u = randInt(0,U);
      return padProblem([C,D,U],[c,d,u]);
    }
    function genBorrowUnitsOnly(){
      let C = randInt(1,9);
      let D = randInt(1,9);
      let U_a = randInt(0,8);
      let U_b = randInt(U_a+1,9);
      let D_b = randInt(0, D-1);
      let C_b = randInt(0, C);
      return padProblem([C,D,U_a],[C_b,D_b,U_b]);
    }
    function genBorrowTensOnly(){
      let C = randInt(1,9);
      let D = randInt(0,8);
      let D_b = randInt(D+1,9);
      let U_a = randInt(0,9), U_b = randInt(0, U_a);
      let C_b = randInt(0, C-1);
      return padProblem([C,D,U_a],[C_b,D_b,U_b]);
    }
    function genCascadeDU(){
      let C = randInt(1,9), D = 0;
      let U_a = randInt(0,8), U_b = randInt(U_a+1,9);
      let C_b = randInt(0, C-1);
      let D_b = randInt(0,9);
      return padProblem([C,D,U_a],[C_b,D_b,U_b]);
    }
    function genDUmix(){
      const r = randInt(1,3);
      if(r===1) return genBorrowUnitsOnly();
      if(r===2) return genBorrowTensOnly();
      return genCascadeDU();
    }
    function genAnyBorrow(){
      const p = Math.random();
      if(p<0.4) return genDUmix();
      if(p<0.8) return genBorrowUnitsOnly();
      return genBorrowTensOnly();
    }

    // Progresi√≥n
    function progressivePlan(idx){
      if(idx < 10) return {stage:"1/4", label:"Sin pr√©stamo", gen:genNoBorrow};
      if(idx < 15) return {stage:"2/4", label:"Pr√©stamo en unidades", gen:genBorrowUnitsOnly};
      if(idx < 25) return {stage:"3/4", label:"Decenas/Unidades (y escalera)", gen:genDUmix};
      return {stage:"4/4", label:"Combinado", gen:genAnyBorrow};
    }

    // Timer
    const timer = {
      duration: 120, remaining: 120, running: false, intervalId: null, beepTimeout: null, lastTs: null,
      start(){ this.stop(); this.remaining=this.duration; this.running=true; this.lastTs=performance.now();
        updateTimerUI(); this.intervalId=setInterval(()=>this.tick(),100); this.scheduleBeep(); },
      stop(){ this.running=false; clearInterval(this.intervalId); this.intervalId=null; clearTimeout(this.beepTimeout); this.beepTimeout=null; },
      tick(){ if(!this.running) return;
        const now=performance.now(); const delta=(now-this.lastTs)/1000; this.lastTs=now; this.remaining=Math.max(0,this.remaining-delta);
        updateTimerUI(); if(this.remaining<=0){ this.stop(); timeUp(); } },
      scheduleBeep(){ clearTimeout(this.beepTimeout); if(!this.running) return;
        const r=Math.max(0,Math.min(1,this.remaining/this.duration));
        const delay=250+900*r; const freq=550+450*(1-r); audio.safeBeep(freq,0.05);
        this.beepTimeout=setTimeout(()=>this.scheduleBeep(),delay); }
    };
    function updateTimerUI(){
      const r = timer.duration>0 ? Math.max(0, Math.min(1, timer.remaining / timer.duration)) : 0;
      el.timeFill.style.width = `${r*100}%`;
      const seconds = Math.ceil(timer.remaining);
      const mm = String(Math.floor(seconds/60)).padStart(2,'0');
      const ss = String(seconds%60).padStart(2,'0');
      el.timeText.textContent = `${mm}:${ss}`;
      if(r<=0.2) el.timer.classList.add('low'); else el.timer.classList.remove('low');
    }

    // Audio
    const audio = {
      ctx:null, master:null, enabled:false, unlocked:false,
      init(){ if(this.ctx) return; const AC=window.AudioContext||window.webkitAudioContext; if(!AC) return;
        this.ctx=new AC(); this.master=this.ctx.createGain(); this.master.gain.value=0.2; this.master.connect(this.ctx.destination); },
      resumeIfSuspended(){ if(this.ctx && this.ctx.state==='suspended'){ return this.ctx.resume(); } return Promise.resolve(); },
      beep(f=800,d=0.06){ if(!this.enabled||!this.ctx) return; const t0=this.ctx.currentTime;
        const osc=this.ctx.createOscillator(), g=this.ctx.createGain(); osc.type='square'; osc.frequency.setValueAtTime(f,t0);
        g.gain.setValueAtTime(0.0001,t0); g.gain.exponentialRampToValueAtTime(0.5,t0+0.01); g.gain.exponentialRampToValueAtTime(0.0001,t0+d);
        osc.connect(g); g.connect(this.master); osc.start(t0); osc.stop(t0+d); },
      safeBeep(f,d){ try{ this.init(); if(!this.unlocked) return; this.beep(f,d); }catch(e){} },
      toggle(){
        this.enabled=!this.enabled;
        el.soundBtn.classList.toggle('off', !this.enabled);
        el.soundBtn.textContent=this.enabled?'üîä':'üîà';
        if(this.enabled){ this.init(); this.resumeIfSuspended().then(()=>{ this.unlocked=true; this.beep(700,0.07); }); }
      },
      unlockOnFirstInteraction(){
        const handler=()=>{
          this.init();
          this.resumeIfSuspended().then(()=>{ this.unlocked=true; });
          window.removeEventListener('pointerdown', handler, {capture:true});
          window.removeEventListener('keydown', handler, {capture:true});
        };
        window.addEventListener('pointerdown', handler, {capture:true, once:true});
        window.addEventListener('keydown', handler, {capture:true, once:true});
      }
    };

    // Stacks y n√∫meros
    function renderStack(container, count, type){
      container.innerHTML=''; const cap = type==='C'?10:type==='D'?10:12;
      const n=Math.min(count,cap);
      for(let i=0;i<n;i++){ const b=document.createElement('div'); b.className=`block ${type}`; container.appendChild(b); }
      if(count>n){ const more=document.createElement('span'); more.style.marginLeft='6px'; more.className='tiny'; more.textContent=`(+${count-n})`; container.appendChild(more); }
    }
    function updateStacks(){
      renderStack(el.stackC, state.workA[0], 'C');
      renderStack(el.stackD, state.workA[1], 'D');
      renderStack(el.stackU, state.workA[2], 'U');
    }

    function clearScribbleUI(){
      state.scribbleNew=[null,null,null];
      state.scribbleExpect=[null,null,null];
      state.scribbleRequired=[false,false,false];
      state.scribbleCorrect=[true,true,true];
      scribbleEls.forEach(elm=>{ elm.innerHTML=''; });
      [el.A_C, el.A_D, el.A_U].forEach(d=>d.classList.remove('crossed'));
    }

    function updateTopNumbers(){
      const digs=[el.A_C, el.A_D, el.A_U];
      const news=[el.newC, el.newD, el.newU];
      for(let i=0;i<3;i++){
        digs[i].textContent = state.A[i];
        const crossed = state.scribbleNew[i] !== null;
        digs[i].classList.toggle('crossed', crossed);
        if(!news[i].querySelector('input')){
          news[i].textContent = (state.scribbleNew[i] !== null && state.scribbleNew[i] !== '') ? String(state.scribbleNew[i]) : '';
        }
      }
      el.B_C.textContent = state.B[0];
      el.B_D.textContent = state.B[1];
      el.B_U.textContent = state.B[2];
    }

    function highlightActive(){
      [el.cellA_C, el.cellA_D, el.cellA_U].forEach(c=>c.classList.remove('active-col'));
      [el.ansC, el.ansD, el.ansU].forEach(i=>i.disabled=true);
      if(state.timedOut){ el.bU.disabled = true; el.bD.disabled = true; el.bC.disabled = true; return; }

      const focusScribbleInput = (col)=>{
        const node = scribbleEls[col].querySelector('input');
        if(node){ node.focus(); node.select && node.select(); }
      };

      if(state.step===2){
        el.cellA_U.classList.add('active-col');
        if(state.requireNewValues && state.scribbleRequired[2] && !state.scribbleCorrect[2]){
          focusScribbleInput(2);
        } else {
          el.ansU.disabled=false; el.ansU.focus();
        }
      } else if(state.step===1){
        el.cellA_D.classList.add('active-col');
        if(state.requireNewValues && state.scribbleRequired[1] && !state.scribbleCorrect[1]){
          focusScribbleInput(1);
        } else {
          el.ansD.disabled=false; el.ansD.focus();
        }
      } else {
        el.cellA_C.classList.add('active-col');
        if(state.requireNewValues && state.scribbleRequired[0] && !state.scribbleCorrect[0]){
          focusScribbleInput(0);
        } else {
          el.ansC.disabled=false; el.ansC.focus();
        }
      }
      el.bU.disabled = !(state.step===2);
      el.bD.disabled = !(state.step===1);
      el.bC.disabled = true;
    }

    function setHint(msg){ el.hint.textContent = msg; }
    function setFeedback(msg, type=''){ el.feedback.textContent = msg||''; el.feedback.className = 'feedback ' + (type||''); }

    function updateStageTag(){
      if(state.mode!=='progresivo'){
        el.stageTag.textContent = 'Modo: ' + ({sin:'Sin pr√©stamo', unidad:'Pr√©stamo en unidades', du:'Decenas/Unidades', aleatorio:'Aleatorio'}[state.mode] || '');
      }else{
        const p=progressivePlan(state.progressIdx); el.stageTag.textContent=`Etapa: ${p.stage} ¬∑ ${p.label}`;
      }
    }
    function updateView(hintMsg){
      updateTopNumbers(); updateStacks(); highlightActive();
      if(hintMsg!==undefined) setHint(hintMsg); setFeedback('');
      el.stat.textContent = `Aciertos: ${state.score.ok} ¬∑ Errores: ${state.score.err}`;
      const r = computeDifference(state.A, state.B);
      el.progress.textContent = `Resultado esperado: ${state.A.join('')} ‚àí ${state.B.join('')} = ${r.join('')}`;
      updateStageTag();
    }

    function needsBorrow(col){ return state.workA[col] < state.B[col]; }
    function blink(node){ node.style.outline='2px solid #3f72ff88'; setTimeout(()=>{ node.style.outline='none'; },350); }
    function flashBad(node){ node.classList.add('shake'); setTimeout(()=>node.classList.remove('shake'),250); }
    function flashWarn(msg){ setFeedback(msg,'bad'); audio.safeBeep(400,0.06); }

    function scribbleSet(col, newVal){
      state.scribbleNew[col] = newVal;
    }

    // Crear input para escribir los nuevos valores arriba
    function requireScribble(col, expected){
      state.scribbleRequired[col] = true;
      state.scribbleCorrect[col] = false;
      state.scribbleExpect[col] = expected;
      state.scribbleNew[col] = '';

      const wrap = scribbleEls[col];
      wrap.innerHTML = '';
      const inp = document.createElement('input');
      inp.type='text'; inp.inputMode='numeric'; inp.maxLength=2; inp.placeholder='?'; inp.className='s-input';
      wrap.appendChild(inp);
      inp.focus();

      const validate = ()=>{
        inp.value = inp.value.replace(/[^\d]/g,'').slice(0,2);
        if(inp.value.length===0) { inp.classList.remove('ok','bad'); return; }
        const val = parseInt(inp.value,10);
        if(val === expected){
          inp.classList.remove('bad'); inp.classList.add('ok');
          state.scribbleCorrect[col] = true;
          state.scribbleNew[col] = expected;
          setTimeout(()=>{
            wrap.innerHTML = String(expected);
            highlightActive();
          }, 120);
          audio.safeBeep(900,0.06);
          setFeedback('¬°Correcto! Nuevo valor registrado.','ok');
        } else {
          inp.classList.remove('ok'); inp.classList.add('bad');
        }
      };
      inp.addEventListener('input', validate);
      inp.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ validate(); highlightActive(); } });
    }

    // Botones de pr√©stamo
    function borrowUnits(){
      if(state.timedOut || state.done[2]) return;
      if(!needsBorrow(2)){ flashWarn("No hace falta reagrupaci√≥n en unidades."); return; }

      let touchedC = false;
      if(state.workA[1]===0){
        if(state.workA[0]===0){ flashWarn("No puedes pedir prestado: no hay centenas disponibles."); return; }
        const oldC = state.workA[0];
        state.workA[0] = oldC - 1;
        state.workA[1] = state.workA[1] + 10;
        touchedC = true;
        blink(el.stackC); blink(el.stackD);
      }

      const oldD2 = state.workA[1];
      const oldU2 = state.workA[2];
      state.workA[1] = oldD2 - 1;
      state.workA[2] = oldU2 + 10;
      blink(el.stackD); blink(el.stackU);

      if(state.requireNewValues){
        if(touchedC){ requireScribble(0, state.workA[0]); }
        requireScribble(1, state.workA[1]);
        requireScribble(2, state.workA[2]);
        setHint("Escribe los nuevos valores arriba (U y D" + (touchedC?", y C":"") + ").");
      } else {
        if(touchedC){ scribbleSet(0, state.workA[0]); }
        scribbleSet(1, state.workA[1]);
        scribbleSet(2, state.workA[2]);
        setHint("¬°Listo! Ahora puedes restar en Unidades.");
      }

      updateView();
      audio.safeBeep(820,0.06);
    }

    function borrowTens(){
      if(state.timedOut || state.done[1]) return;
      if(!needsBorrow(1)){ flashWarn("No hace falta reagrupaci√≥n en decenas."); return; }
      if(state.workA[0]===0){ flashWarn("No puedes pedir prestado: no hay centenas disponibles."); return; }

      const oldC = state.workA[0];
      state.workA[0] = oldC - 1;
      state.workA[1] = state.workA[1] + 10;
      blink(el.stackC); blink(el.stackD);

      if(state.requireNewValues){
        requireScribble(0, state.workA[0]);
        requireScribble(1, state.workA[1]);
        setHint("Escribe los nuevos valores arriba (C y D).");
      } else {
        scribbleSet(0, state.workA[0]);
        scribbleSet(1, state.workA[1]);
        setHint("Convertiste 1 centena en 10 decenas. Ahora resta en Decenas.");
      }

      updateView();
      audio.safeBeep(760,0.06);
    }

    // Vidas
    function updateLivesUI(){
      const hearts = el.livesWrap.querySelectorAll('.heart');
      hearts.forEach((h,i)=> h.classList.toggle('lost', i >= state.lives));
      const idx = Math.max(0, state.lives - 1);
      const heart = hearts[idx];
      if(heart){ heart.classList.add('flash'); setTimeout(()=>heart.classList.remove('flash'), 500); }
    }
    function loseLife(reason=''){
      if(state.lives<=0) return;
      state.lives = Math.max(0, state.lives - 1);
      updateLivesUI();
      if(reason==='wrong'){ setFeedback("¬°Ups! N√∫mero incorrecto. Pierdes una vida.", 'bad'); }
      if(state.lives<=0){ timer.stop(); setTimeout(()=>showGameOver(), 400); }
    }

    // Verificaci√≥n
    function checkColumn(col){
      if(state.timedOut) return;

      if(state.requireNewValues && state.scribbleRequired[col] && !state.scribbleCorrect[col]){
        setFeedback("Antes de restar, escribe el nuevo valor arriba.","bad");
        const node = scribbleEls[col].querySelector('input');
        if(node){ node.focus(); }
        audio.safeBeep(350,0.07);
        return;
      }

      const input = col===2 ? el.ansU : col===1 ? el.ansD : el.ansC;
      const val = input.value.trim();
      if(!/^\d$/.test(val)){ return; }

      if(needsBorrow(col)){
        setFeedback("No alcanza. Debes reagrupuar (pedir prestado) antes de restar.","bad");
        flashBad(input); state.score.err++; audio.safeBeep(300,0.07); loseLife('wrong'); updateView(); return;
      }

      const expected = state.workA[col] - state.B[col];
      if(parseInt(val,10) === expected){
        setFeedback("¬°Bien! Paso correcto.",'ok');
        state.done[col] = true; input.disabled = true; audio.safeBeep(980, 0.07);
        if(col===2){ state.step=1; } else if(col===1){ state.step=0; } else { finishExercise(); return; }
        updateView("Sigue con la siguiente columna.");
      } else {
        setFeedback(`Revisa: ${state.workA[col]} ‚àí ${state.B[col]} = ${expected}. Intenta de nuevo.`,'bad');
        flashBad(input); state.score.err++; audio.safeBeep(280,0.08); loseLife('wrong'); updateView();
      }
    }

    function finishExercise(){
      if(state.timedOut) return;
      if(state.requireNewValues){
        for(let i=0;i<3;i++){
          if(state.scribbleRequired[i] && !state.scribbleCorrect[i]){
            setFeedback("Completa los nuevos valores arriba antes de terminar.","bad");
            const node = scribbleEls[i].querySelector('input'); if(node) node.focus();
            return;
          }
        }
      }

      state.score.ok++; state.score.n++; timer.stop();
      setHint("¬°Robot listo! Has completado la resta.");
      setFeedback("Excelente. Preparando el siguiente reto...",'ok');
      setTimeout(()=>audio.safeBeep(700,0.06), 0);
      setTimeout(()=>audio.safeBeep(900,0.06), 80);
      setTimeout(()=>audio.safeBeep(1100,0.08), 160);
      setTimeout(()=>autoNext(), 800);
    }
    function autoNext(){ if(state.lives<=0) return; state.progressIdx++; generateProblem(state.mode, true); }
    function timeUp(){
      state.timedOut = true;
      setHint("Tiempo agotado. ¬°Perdiste una vida!");
      setFeedback("Se acab√≥ el tiempo ‚è±Ô∏è",'bad');
      [el.ansC,el.ansD,el.ansU].forEach(i=>i.disabled=true);
      [el.bU,el.bD,el.bC].forEach(b=>b.disabled=true);
      state.score.err++; audio.safeBeep(200,0.08); setTimeout(()=>audio.safeBeep(280,0.08),90); setTimeout(()=>audio.safeBeep(360,0.1),180);
      loseLife('time');
      if(state.lives>0){ setTimeout(()=>autoNext(), 1000); }
    }
    function showGameOver(){ el.overlay.style.display='flex'; }
    function resetGame(){
      el.overlay.style.display='none';
      state.lives=6; updateLivesUI();
      state.score={ok:0,err:0,n:0};
      state.progressIdx=0;
      generateProblem(state.mode || 'aleatorio', false);
    }

    // Mostrar soluci√≥n
    function revealSolution(){
      timer.stop();
      clearScribbleUI();
      state.workA=[...state.A];

      if(state.workA[2] < state.B[2]){
        if(state.workA[1]===0){
          state.workA[0]-=1; state.workA[1]+=10;
          scribbleSet(0, state.workA[0]);
          scribbleSet(1, state.workA[1]);
        }
        state.workA[1]-=1; state.workA[2]+=10;
        scribbleSet(1, state.workA[1]);
        scribbleSet(2, state.workA[2]);
      }
      if(state.workA[1] < state.B[1]){
        state.workA[0]-=1; state.workA[1]+=10;
        scribbleSet(0, state.workA[0]);
        scribbleSet(1, state.workA[1]);
      }

      const r = computeDifference(state.A, state.B);
      el.ansC.value = r[0]; el.ansD.value = r[1]; el.ansU.value = r[2];
      state.done=[true,true,true]; state.step=0;
      setHint("Soluci√≥n mostrada. Observa c√≥mo el original queda tachado y el nuevo valor aparece arriba.");
      setFeedback(''); updateView(); el.nextBtn.style.display='inline-block';
    }

    // Selecci√≥n de generador por modo
    function pickGeneratorByMode(mode){
      if(mode==='sin') return genNoBorrow;
      if(mode==='unidad') return genBorrowUnitsOnly;
      if(mode==='du') return genDUmix;
      if(mode==='aleatorio') return genAnyBorrow;
      const plan = progressivePlan(state.progressIdx);
      return plan.gen;
    }
    function computeDurationForIndex(idx){
      const base = parseInt(el.initTime.value,10) || state.config.initTime;
      const dec = parseInt(el.decayTime.value,10) || state.config.decay;
      return Math.max(state.config.minTime, base - dec * idx);
    }
    function generateProblem(mode, fromAuto=false){
      state.mode = mode;
      state.timedOut=false; state.done=[false,false,false]; state.step=2;
      clearScribbleUI();
      el.nextBtn.style.display='none';

      const gen = pickGeneratorByMode(mode);
      const P = gen(); state.A=[...P.A]; state.B=[...P.B]; state.workA=[...P.A];

      el.ansC.value=''; el.ansD.value=''; el.ansU.value='';

      timer.duration = computeDurationForIndex(state.progressIdx);
      timer.start();

      updateView(fromAuto ? "¬°Nuevo reto! Aplica pr√©stamos cuando sea necesario." : "Nuevo ejercicio listo. Comienza por Unidades.");
      audio.safeBeep(700,0.07);
    }

    // Eventos
    el.mode.addEventListener('change', e=>{ state.mode=e.target.value; state.progressIdx=0; generateProblem(state.mode); });

    // Si se activa: 120s. Si se desactiva: 60s.
    el.requireScribble.addEventListener('change', (e)=>{
      state.requireNewValues = e.target.checked;
      if(state.requireNewValues){
        el.initTime.value = 120;
        state.config.initTime = 120;
        setFeedback("Activado: deber√°s escribir los nuevos valores tras pedir prestado. Tiempo inicial = 120 s.", '');
      } else {
        el.initTime.value = 60;
        state.config.initTime = 60;
        setFeedback("Desactivado: los nuevos valores se muestran autom√°ticamente. Tiempo inicial = 60 s.", '');
      }
    });

    el.initTime.addEventListener('change', ()=>{ state.config.initTime = parseInt(el.initTime.value,10) || state.config.initTime; });
    el.decayTime.addEventListener('change', ()=>{ state.config.decay = parseInt(el.decayTime.value,10) || state.config.decay; });
    el.nextBtn.addEventListener('click', ()=>generateProblem(state.mode));
    el.revealBtn.addEventListener('click', revealSolution);
    el.soundBtn.addEventListener('click', ()=>audio.toggle());
    el.restartBtn.addEventListener('click', resetGame);

    [el.ansU, el.ansD, el.ansC].forEach(inp=>{
      inp.addEventListener('input', (e)=>{
        e.target.value = e.target.value.replace(/[^\d]/g,'').slice(0,1);
        const col = (e.target===el.ansU) ? 2 : (e.target===el.ansD) ? 1 : 0;
        checkColumn(col);
      });
      inp.addEventListener('focus', ()=> setFeedback(''));
      inp.addEventListener('keydown', (ev)=>{
        if(ev.key==='Enter'){
          const col = (ev.target===el.ansU) ? 2 : (ev.target===el.ansD) ? 1 : 0;
          checkColumn(col);
        }
      });
    });

    el.bU.addEventListener('click', borrowUnits);
    el.bD.addEventListener('click', borrowTens);

    // Inicio
    (function init(){
      audio.init();
      audio.unlockOnFirstInteraction();

      state.mode = el.mode.value || 'aleatorio';
      state.requireNewValues = el.requireScribble.checked;

      // Por defecto, checkbox activo => 120s; si no, 60s
      if(state.requireNewValues){
        el.initTime.value = 120;
        state.config.initTime = 120;
      } else {
        el.initTime.value = 60;
        state.config.initTime = 60;
      }
      state.config.decay = parseInt(el.decayTime.value,10);

      updateLivesUI(); updateStageTag();
      generateProblem(state.mode);
    })();
  </script>
</body>
</html>